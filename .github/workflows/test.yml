name: Test

on: [push, pull_request]

jobs:
  test-deploy:
    name: Test able to deploy to npm
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: plugin
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Compile
        run: npm run build

      - name: Publish test
        run: npm publish --dry-run

  test-plugin:
    name: Test unit tests for plguin
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install plugin dependencies
        working-directory: plugin
        run: npm ci

      - name: Install root dependencies
        run: npm ci

      - name: Run plugin tests
        run: npm run test-plugin
  
  build-android-app:
    name: Build and compile Android app to ensure correctness
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install plugin dependencies
        working-directory: plugin
        run: npm ci

      - name: Setup test project
        run: npm run setup-tests

      - name: Build Android app
        working-directory: test-app/android
        run: ./gradlew assembleDebug

  build-ios-app:
    name: Build and compile iOS app to ensure correctness
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install XCode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "15.3"

      - name: Install plugin dependencies
        working-directory: plugin
        run: npm ci

      - name: Setup test project
        run: npm run setup-tests

      - name: Build iOS app
        working-directory: test-app/ios
        run: xcodebuild -workspace ExpoTestApp.xcworkspace -scheme ExpoTestApp -sdk iphonesimulator -configuration Debug build
